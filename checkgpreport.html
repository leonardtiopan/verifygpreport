<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Verifikasi Kesesuaian GP Report — APO Six Steps & Thirteen Tasks</title>
  <meta name="description" content="Unggah GP report dan verifikasi APO Six Steps & Thirteen Tasks dengan status 'Sesuai' atau 'Tidak Sesuai'. Non-blocking, progress, cancel, TXT rekomendasi." />
  <link rel="preconnect" href="https://unpkg.com">
  <style>
    :root{
      --bg:#0b1220;--card:#10192b;--ink:#e6eefb;--muted:#a9b4c7;
      --brand:#4fd1c5;--accent:#a78bfa;--bad:#ef4444;--good:#10b981;--warn:#f59e0b;
      --border:#1a2440;--ink-dark:#07121e
    }
    html,body{background:var(--bg);color:var(--ink);font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial;margin:0}
    a{color:var(--brand);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1080px;margin:24px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin:14px 0;box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .hero{display:flex;flex-direction:column;align-items:center;text-align:center;gap:10px;margin:8px 0 14px}
    .hero img{height:auto;max-height:70px;width:auto;object-fit:contain}
    .hero-title{font-size:clamp(18px,3.8vw,26px);font-weight:800;line-height:1.25}
    .hero-sub{font-size:clamp(14px,2.6vw,16px);color:var(--muted)}
    .support{font-size:clamp(13px,2.4vw,15px);color:var(--muted)}
    button{background:linear-gradient(135deg,var(--brand),#61dafb);border:0;color:var(--ink-dark);padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button.ghost{background:#0f1b34;color:var(--ink);border:1px solid #243a63}
  </style>

  <script defer src="https://unpkg.com/pdfjs-dist@3.10.111/legacy/build/pdf.min.js"></script>
  <script defer src="https://unpkg.com/pdfjs-dist@3.10.111/legacy/build/pdf.worker.min.js"></script>
  <script defer src="https://unpkg.com/mammoth@1.7.0/mammoth.browser.min.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header dengan logo APO -->
    <div class="card hero" style="padding:22px 16px">
      <img src="https://www.apo-tokyo.org/wp-content/uploads/2021/12/apo-logo.png" alt="APO Logo" />
      <div class="hero-title">Verify and Check GP Report based on APO Six Steps Thirteen Task Methodology</div>
      <div class="hero-sub">developed by <b>Leonard Tiopan Panjaitan, MT, CSRA, CGPS, CPS</b> — ©2025</div>
      <div class="support">This website is supported by <a href="https://greenproductivity.online" target="_blank" rel="noopener">greenproductivity.online</a></div>
    </div>

    <div class="card">
      <input id="file" type="file" accept=".pdf,.docx,.txt,.md"/>
      <div style="margin-top:10px;display:flex;flex-wrap:wrap;gap:10px">
        <button id="run">Jalankan Verifikasi</button>
        <button id="cancel" class="ghost">Batalkan</button>
        <button id="reset" class="ghost">Reset</button>
        <button id="exportTxt" class="ghost">Unduh TXT</button>
        <button id="exportJson" class="ghost">Ekspor JSON</button>
      </div>
    </div>

    <div id="status" class="card" style="display:none"></div>
  </div>

<script>
const el = s => document.querySelector(s);
let lastResult=null, lastFile=null;

// Worker (dipotong — gunakan versi lengkap dari script Anda sebelumnya)
const workerCode = `self.onmessage=(e)=>{self.postMessage({ok:true,result:{pass:true,evid:{gaps:[]},tasksAvg:0.8,envScore:0.7,methodBase:0.6,composite:0.72}})}`;
const worker=new Worker(URL.createObjectURL(new Blob([workerCode],{type:'application/javascript'})));

function verifyInWorker(text){
  return new Promise((resolve,reject)=>{
    const onMsg=(ev)=>{worker.removeEventListener('message',onMsg);resolve(ev.data.result);}
    worker.addEventListener('message',onMsg,{once:true});
    worker.postMessage({cmd:'verify',payload:{text}});
    setTimeout(()=>{reject(new Error('Timeout'));},120000);
  });
}

el('#run').addEventListener('click',async()=>{
  const file=el('#file').files[0];
  if(!file){alert('Pilih berkas terlebih dahulu');return;}
  lastFile=file;
  const txt=await file.text();
  const v=await verifyInWorker(txt);
  lastResult=v;
  el('#status').style.display='block';
  el('#status').innerHTML=`<b>Status:</b> ${v.pass?'Sesuai ✅':'Tidak Sesuai ❌'}`;
});

el('#exportJson').addEventListener('click',()=>{
  if(!lastResult){alert('Belum ada hasil.');return;}
  const now=new Date();
  const headerInfo=`Developed by Leonard Tiopan Panjaitan, MT, CGPS, CPS — ${now.toLocaleString('id-ID')}`;
  const payload={
    fileName:lastFile?.name||null,
    computedAt:now.toISOString(),
    status:lastResult.pass?'Sesuai':'Tidak Sesuai',
    scores:{
      tasksAvg:lastResult.tasksAvg,
      envScore:lastResult.envScore,
      methodScore:lastResult.methodBase,
      composite:lastResult.composite
    },
    gaps:lastResult.evid.gaps
  };
  const finalText=headerInfo+'\n\n'+JSON.stringify(payload,null,2);
  const blob=new Blob([finalText],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=(lastFile?.name||'report')+'.apo-verification.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});

el('#exportTxt').addEventListener('click',()=>{
  if(!lastResult){alert('Belum ada hasil.');return;}
  const now=new Date();
  const lines=[];
  lines.push('Developed by Leonard Tiopan Panjaitan, MT, CGPS, CPS — '+now.toLocaleString('id-ID'));
  lines.push('===============================================');
  lines.push('Nama Berkas     : '+(lastFile?.name||'-'));
  lines.push('Status Akhir    : '+(lastResult.pass?'SESUAI':'TIDAK SESUAI'));
  const txt=lines.join('\n');
  const blob=new Blob([txt],{type:'text/plain;charset=utf-8'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=(lastFile?.name||'report')+'.apo-verification.txt';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
</script>
</body>
</html>
